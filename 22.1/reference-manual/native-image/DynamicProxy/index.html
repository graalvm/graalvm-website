<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:image" content='/22.1/resources/img/graalvm.png' />
  <meta name="twitter:widgets:border-color" content="#55acee">

  <title>
    
      GraalVM
    
  </title>
  <meta name="description" content="GraalVM is an advanced JDK with ahead-of-time Native Image compilation."/>

  <link rel="icon" id="favicon" href='/22.1/resources/img/favicon/favicon-light/favicon-light.ico'>

  <link rel="manifest" href='/22.1/resources/img/favicon/site.webmanifest'>
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">

  <script src='/22.1/resources/lib/jquery/jquery-3.6.1.min.js'></script>
  <link rel="stylesheet" href='/22.1/assets/main.css'>
  <script src='/22.1/resources/lib/bootstrap/js/bootstrap.min.js'></script>
  <script src='/22.1/resources/lib/highlight/highlight.pack.js'></script>
  <script src='/22.1/resources/lib/purl/purl.js'></script>
  <script src='/22.1/resources/lib/fiddle/fiddle.js' defer></script>
  <link rel="stylesheet" href='/22.1/resources/styles/fiddle.css'>
  <script async defer src="https://buttons.github.io/buttons.js"></script>
</head>

  <body class="preload">

    <div>
      <header  class="header header--content"  role="banner">

  

  <div class="container-fluid container-fluid--custom-sm">
    <div class="row">
      <div class="col-12 col-sm-12 col-md-12 col-lg-10">
        <div class="d-flex">
          <a href="https://www.graalvm.org/">
            <img src="resources/img/logo_header.svg" alt="GraalVM logo">
          </a>  
        </div>
      </div>
    </div>
  </div>
</header>
      <main class="content content--home wrapper" aria-label="Content">
        <div class="container-fluid container-fluid--custom-sm">
  <div class="row">
    <div class="col-12 col-sm-12 col-md-12 col-lg-10 offset-lg-1">
      <br>
      <a href="/22.1/" class="link-back"><i>&#9664;</i>Table of Contents</a>

      <h1 id="dynamic-proxy-in-native-image">Dynamic Proxy in Native Image</h1>

<p>Java dynamic proxies, implemented by <code>java.lang.reflect.Proxy</code>, provide a mechanism which enables object level access control by routing all method invocations through <code>java.lang.reflect.InvocationHandler</code>.
Dynamic proxy classes are generated from a list of interfaces.</p>

<p>Native Image does not provide machinery for generating and interpreting bytecodes at run time.
Therefore all dynamic proxy classes need to be generated at native image build time.</p>

<p>See also the <a href="/22.1/reference-manual/native-image/BuildConfiguration/#assisted-configuration-of-native-image-builds">guide on assisted configuration of Java resources and other dynamic features</a>.</p>

<h2 id="automatic-detection">Automatic Detection</h2>

<p>Native Image employs a simple static analysis that detects calls to <code>java.lang.reflect.Proxy.newProxyInstance(ClassLoader, Class&lt;?&gt;[], InvocationHandler)</code> and <code>java.lang.reflect.Proxy.getProxyClass(ClassLoader, Class&lt;?&gt;[])</code>, then tries to determine the list of interfaces that define dynamic proxies automatically.
Given the list of interfaces, Native Image generates proxy classes at image build time and adds them to the native image heap.
In addition to generating the dynamic proxy class, the constructor of the generated class that takes a <code>java.lang.reflect.InvocationHandler</code> argument, i.e., the one reflectively invoked by <code>java.lang.reflect.Proxy.newProxyInstance(ClassLoader, Class&lt;?&gt;[], InvocationHandler)</code>, is registered for reflection so that dynamic proxy instances can be allocated at run time.</p>

<p>The analysis is limited to situations where the list of interfaces comes from a constant array or an array that is allocated in the same method.
For example, in the code snippets bellow the dynamic proxy interfaces can be determined automatically.</p>

<h4 id="static-final-array">Static Final Array:</h4>

<pre><code class="language-java">class ProxyFactory {

    private static final Class&lt;?&gt;[] interfaces = new Class&lt;?&gt;[]{java.util.Comparator.class};

    static Comparator createProxyInstanceFromConstantArray() {
        ClassLoader classLoader = ProxyFactory.class.getClassLoader();
        InvocationHandler handler = new ProxyInvocationHandler();
        return (Comparator) Proxy.newProxyInstance(classLoader, interfaces, handler);
    }
}
</code></pre>
<p>Note: The analysis operates on compiler graphs and not source code.
Therefore the following ways to declare and populate an array are equivalent from the point of view of the analysis:</p>

<pre><code class="language-java">private static final Class&lt;?&gt;[] interfacesArrayPreInitialized = new Class&lt;?&gt;[]{java.util.Comparator.class};
</code></pre>

<pre><code class="language-java">private static final Class&lt;?&gt;[] interfacesArrayLiteral = {java.util.Comparator.class};
</code></pre>

<pre><code class="language-java">private static final Class&lt;?&gt;[] interfacesArrayPostInitialized = new Class&lt;?&gt;[1];
static {
    interfacesArrayPostInitialized[0] = java.util.Comparator.class;
}
</code></pre>
<p>However, there are no immutable arrays in Java.
Even if the array is declared as <code>static final</code>, its contents can change later on.
The simple analysis employed here does not track further changes to the array.</p>

<h4 id="new-array">New Array:</h4>

<pre><code class="language-java">class ProxyFactory {

    static Comparator createProxyInstanceFromNewArray() {
        ClassLoader classLoader = ProxyFactory.class.getClassLoader();
        InvocationHandler handler = new ProxyInvocationHandler();
        Class&lt;?&gt;[] interfaces = new Class&lt;?&gt;[]{java.util.Comparator.class};
        return (Comparator) Proxy.newProxyInstance(classLoader, interfaces, handler);
    }
}
</code></pre>

<p>Note: Just like with constant arrays, the following ways to declare and populate an array are equivalent from the point of view of the analysis:</p>
<pre><code class="language-java">Class&lt;?&gt;[] interfaces = new Class&lt;?&gt;[]{java.util.Comparator.class};
</code></pre>

<pre><code class="language-java">Class&lt;?&gt;[] interfaces = new Class&lt;?&gt;[1];
interfaces[0] = Question.class;
</code></pre>

<pre><code class="language-java">Class&lt;?&gt;[] interfaces = {java.util.Comparator.class};
</code></pre>

<p>The static analysis covers code patterns most frequently used to define dynamic proxy classes.
For the exceptional cases where the analysis cannot discover the interface array there is also a manual dynamic proxy configuration mechanism.</p>

<h2 id="manual-configuration">Manual Configuration</h2>

<p>Dynamic proxy classes can be generated at native image build time by specifying the list of interfaces that they implement.
Native Image provides two options for that: <code>-H:DynamicProxyConfigurationFiles=&lt;comma-separated-config-files&gt;</code> and <code>-H:DynamicProxyConfigurationResources=&lt;comma-separated-config-resources&gt;</code>. These options accept JSON files whose structure is an array of arrays of fully qualified interface names. For example:</p>

<pre><code class="language-json">[
 { "interfaces": [ "java.lang.AutoCloseable", "java.util.Comparator" ] },
 { "interfaces": [ "java.util.Comparator" ] },
 { "interfaces": [ "java.util.List" ] }
]
</code></pre>
<p>Note that the order of the specified proxy interfaces is significant: two requests for a <code>Proxy</code> class with the same combination of interfaces but in a different order will result in two distinct behaviours (for more detailed information, refer to <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/reflect/Proxy.html"><code>Proxy Class </code>javadoc</a>.</p>

<p>The <code>java.lang.reflect.Proxy</code> API also allows creation of a dynamic proxy that does not implement any user provided interfaces.
In this case the generated dynamic proxy class only implements <code>java.lang.reflect.Proxy</code>.</p>

<h2 id="dynamic-proxy-classes-in-static-initializers">Dynamic Proxy Classes in Static Initializers</h2>

<p>Dynamic proxy classes and instances of dynamic proxy classes that are defined in static initializers can be accessed at run time without any special handling.
This is possible since the static initializers are executed at native image build time.
For example, this will work:</p>
<pre><code class="language-java">private final static Comparator proxyInstance;
private final static Class&lt;?&gt; proxyClass;
static {
    ClassLoader classLoader = ProxyFactory.class.getClassLoader();
    InvocationHandler handler = new ProxyInvocationHandler();
    Class&lt;?&gt;[] interfaces = {java.util.Comparator.class};
    proxyInstance = (Comparator) Proxy.newProxyInstance(classLoader, interfaces, handler);
    proxyClass = Proxy.getProxyClass(classLoader, interfaces);
}
</code></pre>

      </div>
  </div>
</div>
      </main>
      <footer class="footer footer__mobile">
  <div class="container-fluid container-fluid--custom-sm">
    <div class="row footer-content">
      <div class="footer__columns">
        <div class="footer__columns-item">
          <h6 class="title-footer" onclick="fadeInAndOut(this)">API Documentation</h6>
          <div class="grow">
            <ul class="footer-list">
              <li class="footer-list__item"><a href="https://www.graalvm.org/sdk/javadoc/">GraalVM SDK Javadoc</a></li>
              <li class="footer-list__item"><a href="https://www.graalvm.org/truffle/javadoc/">GraalVM Truffle Javadoc</a></li>
            </ul>
          </div>
        </div>
        <div class="footer__columns-item">
          <h6 class="title-footer" onclick="fadeInAndOut(this)">Learn More</h6>
          <div class="grow">
            <ul class="footer-list">
              <li class="footer-list__item"><a href="https://github.com/oracle/graal/" target="_blank">Open Source Repository</a></li>
              <li class="footer-list__item"><a href="https://www.graalvm.org/release-notes/" target="_blank">Release notes</a></li>
              <li class="footer-list__item"><a href="https://github.com/graalvm/graalvm-demos/"
                  target="_blank">Demos</a></li>
              <li class="footer-list__item"><a href="https://medium.com/graalvm" target="_blank">Blog</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-12 col-md-12 col-lg-12">
      <div class="row">
        <div class="col-sm-12">
          <p class="copyright">
            Copyright © 2024, Oracle and/or its affiliates. All rights reserved. Oracle and Java are registered trademarks. Other names may be trademarks of their respective owners.
          </p>
        </div>
      </div>
    </div>
  </div>
</footer>

<script>
  function fadeInAndOut(thz) {
    var elmt = thz.nextElementSibling;//Get the element that is below the button that
    //was just clicked
    if (elmt.clientHeight) {
      elmt.style.height = 0;
    } else {
      var wrapper = elmt.querySelector('ul');
      elmt.style.height = wrapper.clientHeight + "px";
    }
  }
</script>

    </div>

    <div class="overlay"></div>

    <script src='/22.1/resources/js/main.js'></script>
  </body>

</html>
