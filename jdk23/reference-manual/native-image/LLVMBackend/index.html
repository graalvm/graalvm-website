<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:image" content='/jdk23/resources/img/graalvm.png' />
  <meta name="twitter:widgets:border-color" content="#55acee">

  <title>
    
      GraalVM
    
  </title>
  <meta name="description" content="GraalVM is an advanced JDK with ahead-of-time Native Image compilation."/>

  <link rel="icon" id="favicon" href='/jdk23/resources/img/favicon/favicon-light/favicon-light.ico'>

  <link rel="manifest" href='/jdk23/resources/img/favicon/site.webmanifest'>
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">

  <script src='/jdk23/resources/lib/jquery/jquery-3.6.1.min.js'></script>
  <link rel="stylesheet" href='/jdk23/assets/main.css'>
  <script src='/jdk23/resources/lib/bootstrap/js/bootstrap.min.js'></script>
  <script src='/jdk23/resources/lib/highlight/highlight.pack.js'></script>
  <script src='/jdk23/resources/lib/purl/purl.js'></script>
  <script src='/jdk23/resources/lib/fiddle/fiddle.js' defer></script>
  <link rel="stylesheet" href='/jdk23/resources/styles/fiddle.css'>
  <script async defer src="https://buttons.github.io/buttons.js"></script>
</head>

  <body class="preload">

    <div>
      <header  class="header header--content"  role="banner">

  

  <div class="container-fluid container-fluid--custom-sm">
    <div class="row">
      <div class="col-12 col-sm-12 col-md-12 col-lg-10">
        <div class="d-flex">
          <a href="https://www.graalvm.org/">
            <img src='/jdk23/resources/img/logo_header.svg' alt="GraalVM logo">
          </a>  
        </div>
      </div>
    </div>
  </div>
  <div>
    <div class="row">
      <div class="docsnote">
        <div class="docsnote__body">
          <div class="docsnote__column">
            <div class="docsnote__card">
              <div class="container">
                <div class="rightside">
                  <img src='/jdk23/resources/img/note-icon-docs-light.svg'>
                  <p class="docsnote__subtitle">
                    This documentation is for an old GraalVM version. See the 
                    <a href="#" onclick="selected('latest', 'latest'); return false;">latest version</a>.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>
      <main class="content content--home wrapper" aria-label="Content">
        <div class="container-fluid container-fluid--custom-sm">
  <div class="row">
    <div class="col-12 col-sm-12 col-md-12 col-lg-10 offset-lg-1">
      <br>
      <a href="/jdk23/" class="link-back"><i>&#9664;</i>Table of Contents</a>
      <h1 id="llvm-backend-for-native-image">LLVM Backend for Native Image</h1>

<p>Native Image provides an alternative backend that uses the <a href="https://llvm.org/docs/LangRef.html">LLVM intermediate representation</a> and the <a href="http://llvm.org/docs/CommandGuide/llc.html">LLVM compiler</a> to produce native executables.
This LLVM backend enables users to <a href="#how-to-add-a-target-architecture-to-graalvm-using-llvm-backend">target alternative architectures</a> that are not directly supported by GraalVM Native Image. However, this approach introduces some performance costs.</p>

<h2 id="installing-and-usage">Installing and Usage</h2>

<p>The LLVM Backend is not included by default as part of Native Image. To use it, you need to <a href="https://github.com/oracle/graal/blob/master/vm/README.md" target="_blank">build GraalVM from source</a> using the following <a href="https://github.com/graalvm/mx/" target="_blank">mx</a> commands:</p>
<pre><code class="language-shell">mx --dynamicimports /substratevm build
export JAVA_HOME=$(mx --dynamicimports /substratevm graalvm-home)
</code></pre>

<p>To enable the LLVM backend, pass the <code>-H:CompilerBackend=llvm</code> option to the <code>native-image</code> command.</p>

<h2 id="code-generation-options">Code Generation Options</h2>

<ul>
  <li><code>-H:+BitcodeOptimizations</code>: enables aggressive optimizations at the LLVM bitcode level. This is experimental and may cause bugs.</li>
</ul>

<h2 id="debugging-options">Debugging Options</h2>

<ul>
  <li><code>-H:TempDirectory=</code>: specifies where the files generated by Native Image will be saved. The LLVM files are saved under <code>SVM-&lt;timestamp&gt;/llvm</code> in this directory.</li>
  <li><code>-H:LLVMMaxFunctionsPerBatch=</code>: specifies the maximum size of a compilation batch*. Setting it to 1 compiles every function separately, 0 compiles everything as a single batch.</li>
  <li><code>-H:DumpLLVMStackMap=</code>: specifies a file in which to dump debugging information, including a mapping between compiled functions and the name of the corresponding bitcode file.</li>
</ul>

<p><em>About batches</em>: LLVM compilation happens in four phases:</p>
<ol>
  <li>LLVM bitcode files (named <code>f0.bc</code>, <code>f1.bc</code>, etc.,) are created for each function.</li>
  <li>The bitcode files are linked into batches (named <code>b0.bc</code>, <code>b1.bc</code>, etc.). This phase is skipped when <code>-H:LLVMMaxFunctionsPerBatch=1</code> is specified.</li>
  <li>The batches are optimized (into <code>b0o.bc</code>, <code>b1o.bc</code>, etc.,) and then compiled (into <code>b0.o</code>, <code>b1.o</code>, etc.).</li>
  <li>The compiled batches are linked into a single object file (<code>llvm.o</code>), which is then linked into the final executable.</li>
</ol>

<h2 id="how-to-add-a-target-architecture-to-graalvm-using-llvm-backend">How to Add a Target Architecture to GraalVM Using LLVM Backend</h2>

<p>An interesting use case for the LLVM backend is to target a new architecture without having to implement a completely new backend for Native Image.
The following are the necessary steps to achieve this at the moment.</p>

<h3 id="target-specific-llvm-settings">Target-Specific LLVM Settings</h3>

<p>There are a few instances where the GraalVM code has to go deeper than the target-independent nature of LLVM.
These are most notably inline assembly snippets to implement direct register accesses and direct register jumps (for trampolines), as well as precisions about the structure of the stack frames of the code emitted by LLVM.
This represents less than a dozen simple values to be set for each new target.</p>

<p><em>(<a href="https://github.com/oracle/graal/commit/80cceec6f6299181d94e844eb22dffbef3ecc9e4">Complete set of values for AArch64</a>)</em></p>

<h3 id="llvm-statepoint-support">LLVM Statepoint Support</h3>

<p>While the LLVM backend uses mostly common, well-supported features of LLVM, garbage collection support implies the use of statepoint intrinsics, an experimental feature of LLVM.
This means that supporting a new architecture will require the implementation of statepoints in LLVM for the requested target.
As most of the statepoint logic is handled at the bitcode level (that is, at a target-independent stage), this is mostly a matter of emitting the right type of calls to lower the statepoint intrinsics.</p>

<p><em>(<a href="https://reviews.llvm.org/D66012">Implementation of statepoints for AArch64</a>)</em></p>

<h3 id="object-file-support">Object File Support</h3>

<p>The data section for programs created with the LLVM backend of the Graal compiler is emitted independently from the code, which is handled by LLVM.
This means that the Graal compiler needs an understanding of object file relocations for the target architecture to be able to link the LLVM-compiled code with the GraalVM-generated data section.</p>

<p><em>(see <code>ELFMachine$ELFAArch64Relocations</code> for an example)</em></p>

<h3 id="further-reading">Further Reading</h3>

<ul>
  <li><a href="/jdk23/reference-manual/native-image/basics/">Native Image Basics</a></li>
</ul>

      </div>
  </div>
</div>
      </main>
      <footer class="footer footer__mobile">
  <div class="container-fluid container-fluid--custom-sm">
    <div class="row footer-content">
      <div class="footer__columns">
        <div class="footer__columns-item">
          <h6 class="title-footer">API Documentation</h6>
          <div class="grow">
            <ul class="footer-list">
              <li class="footer-list__item"><a href="https://www.graalvm.org/sdk/javadoc/">GraalVM SDK Javadoc</a></li>
              <li class="footer-list__item"><a href="https://www.graalvm.org/truffle/javadoc/">GraalVM Truffle Javadoc</a></li>
            </ul>
          </div>
        </div>
        <div class="footer__columns-item">
          <h6 class="title-footer">Learn More</h6>
          <div class="grow">
            <ul class="footer-list">
              <li class="footer-list__item"><a href="https://github.com/oracle/graal/" target="_blank">Open Source Repository</a></li>
              <li class="footer-list__item"><a href="https://www.graalvm.org/release-notes/" target="_blank">Release notes</a></li>
              <li class="footer-list__item"><a href="https://github.com/graalvm/graalvm-demos/"
                  target="_blank">Demos</a></li>
              <li class="footer-list__item"><a href="https://medium.com/graalvm" target="_blank">Blog</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-12 col-md-12 col-lg-12">
      <div class="row">
        <div class="col-sm-12">
          <p class="copyright">
            Copyright Â© 2024, Oracle and/or its affiliates. All rights reserved. Oracle and Java are registered trademarks. Other names may be trademarks of their respective owners.
          </p>
        </div>
      </div>
    </div>
  </div>
</footer>

    </div>

    <div class="overlay"></div>

    <script src='/jdk23/resources/js/main.js'></script>
  </body>

</html>
